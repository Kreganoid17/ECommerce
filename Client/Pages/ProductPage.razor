@page "/ProductPage"
@using ECommerceApp.Shared
@using ECommerceApp.Shared.DTO
@inject ECommerceApp.Client.Services.IProductsController Products
@inject ECommerceApp.Client.Services.ICartController Cart
@inject ISyncLocalStorageService LocalStorage
@inject IToastService ToastService
@inject NavigationManager NavMan
@inject HttpClient client


<link href = "css/CardStyle.css" rel = "stylesheet" >
<link href="_content/Blazored.Toast/blazored-toast.css" rel="stylesheet" />
<link href="css/Loading.css" rel="stylesheet" />

@if (Products.products == null)
{
    
    <div id="circle">
                <div class="loader">
                    <div class="loader">
                        <div class="loader">
                            <div class="loader">

                            </div>
                        </div>
                    </div>
                </div>
            </div>   

}else{

    <AuthorizeView>

        <NotAuthorized>

            <div class = "text-center">

                <h1>Welcome To The Shop!</h1>

            </div>
            <br>

        </NotAuthorized>

        <Authorized>

            @{AuthDTO username = LocalStorage.GetItem<AuthDTO>("User");}

            <div class = "text-center">

            <h1>Welcome Back @username.Username To The Shop!</h1>

            </div>
            <br>

        </Authorized>

    </AuthorizeView>


        <div class = "col-12">

            <div class = "row">

            @foreach(var product in Products.products)
            {
                <div class = "col-3">

                    <div class="card w-100 mb-3">

                        @{string ImgSrc = "Content/Images/" + product.ProductName + ".jpg";}

                        <img src = "@ImgSrc" @onclick = "() => ShowDetails(product.ProductID)" id = "ProductImg">
                        <h1 style = "font-size:30px;" @onclick = "() => ShowDetails(product.ProductID)" id = "Product"> @product.ProductName</h1>
                        <p class="price">R @product.Price</p>

                        <AuthorizeView>

                            <Authorized>

                                <div class = "w-100" @onclick = "() => AddToCart(product)" id = "AddToCart">

                                    <div style = "top:50%;">

                                        Add to Cart

                                    </div>

                                </div>

                            </Authorized>

                        </AuthorizeView>
                        

                    </div>
  
                </div>

            }

            </div>

        </div>

  
}

@code {

    protected override async Task OnInitializedAsync()
    {
        await Products.GetProducts();

    }

    private void ShowDetails(int Id) {

        NavMan.NavigateTo($"/ProductDetails/{Id}");

    }

    private void AddToCart(Product product) {

        Cart.AddToCart(product);

        ToastService.ShowSuccess(product.ProductName + " Has Been Added", "Added To Cart");

    }

}
